FROM quay.io/centos-bootc/centos-bootc:stream9

# Versioning Toggle (build-arg)
ARG MS_VERSION=4.20

# 1. Setup External Repos for Dependencies (Matching MS_VERSION)
RUN dnf install -y 'dnf-command(config-manager)' && \
    printf "[openshift-mirror-beta]\n\
name=OpenShift Mirror Beta Repository\n\
baseurl=https://mirror.openshift.com/pub/openshift-v4/x86_64/dependencies/rpms/%s-el9-beta/\n\
enabled=1\n\
gpgcheck=0\n\
skip_if_unavailable=0\n" \
    $MS_VERSION > /etc/yum.repos.d/openshift.repo

# 2. Setup Local Versioned Repo
COPY rpms /tmp/rpms
COPY microshift-rpms-4.20x86_64 /tmp/microshift-rpms-4.20x86_64

RUN if [ "$MS_VERSION" = "4.20" ]; then \
        mv /tmp/microshift-rpms-4.20x86_64 /tmp/local-rpms; \
    else \
        mv /tmp/rpms /tmp/local-rpms; \
    fi && \
    dnf install -y createrepo_c && \
    createrepo_c /tmp/local-rpms && \
    printf "[local]\nname=local\nbaseurl=file:///tmp/local-rpms\nenabled=1\ngpgcheck=0" > /etc/yum.repos.d/local.repo

# 3. Install MicroShift Stack
RUN dnf install -y --nogpgcheck \
    microshift microshift-kindnet microshift-networking \
    microshift-topolvm microshift-olm microshift-selinux \
    jq skopeo firewalld policycoreutils && \
    dnf clean all && rm -rf /tmp/local-rpms /etc/yum.repos.d/local.repo

# 4. Copy Assets & Scripts
RUN mkdir -p /etc/cni/net.d /etc/microshift/manifests.d/001-test-app /usr/local/bin
# Copy CRI-O Kindnet configuration
COPY assets/13-microshift-kindnet.conf /etc/crio/crio.conf.d/13-microshift-kindnet.conf
COPY assets/10-kindnet.conflist /etc/cni/net.d/10-kindnet.conflist
COPY assets/99-offline.conf /etc/containers/registries.conf.d/99-offline.conf
COPY scripts/setup.sh /usr/local/bin/setup-storage.sh
COPY ./scripts/embed_image.sh /usr/local/bin/embed_image.sh
COPY ./scripts/copy_embed.sh /usr/local/bin/copy_embed.sh
COPY manifests/test-app.yaml /etc/microshift/manifests.d/001-test-app/test-app.yaml
COPY image-list.txt /tmp/image-list.txt
# --- PERMISSIONS FIX START ---
# 1. Set Execute permissions for all scripts
RUN chmod +x /usr/local/bin/*.sh

RUN /usr/local/bin/embed_image.sh /tmp/image-list.txt
# 2. Ensure systemd unit files are 644 (not executable)
# Note: We create the services below, but if you COPY any, fix them here.
RUN chmod 644 /etc/systemd/system/*.service || true

# 3. SELinux Relabeling (Critical for systemd execution)
# restorecon resets the labels to the system defaults for these paths
RUN restorecon -R -v /usr/local/bin && \
    restorecon -R -v /etc/systemd/system && \
    restorecon -R -v /etc/microshift/manifests
# --- PERMISSIONS FIX END ---

# 5. Networking & Firewall
RUN firewall-offline-cmd --zone=public --add-port=22/tcp --add-port=80/tcp --add-port=443/tcp && \
    firewall-offline-cmd --zone=public --add-port=6443/tcp --add-port=30000-32767/tcp && \
    firewall-offline-cmd --zone=trusted --add-source=10.42.0.0/16 --add-source=169.254.169.1

# 6. User Config
RUN useradd -m -d /var/home/hrushabh -G wheel hrushabh && echo "hrushabh:redhat" | chpasswd

# 7. Systemd Services Creation
COPY ./scripts/microshift-embed.service /usr/lib/systemd/system/microshift-embed.service

RUN printf "[Unit]\nDescription=Setup Storage\nBefore=microshift.service\n\n[Service]\nType=oneshot\nExecStart=/usr/local/bin/setup-storage.sh\nRemainAfterExit=yes\n\n[Install]\nWantedBy=multi-user.target" > /etc/systemd/system/microshift-storage-setup.service

RUN cat > /usr/lib/systemd/system/microshift-make-rshared.service <<'EOF'
[Unit]
Description=Make root filesystem shared
Before=microshift.service
[Service]
Type=oneshot
ExecStart=/usr/bin/mount --make-rshared /
[Install]
WantedBy=multi-user.target
EOF

# 8. Cleanup & Final Prep
RUN rm -rf /usr/lib/microshift/manifests/microshift-olm
RUN restorecon -R -v /usr/lib/systemd/system

# 9. Enable Services
RUN systemctl enable firewalld \
    microshift-make-rshared.service \
    microshift-embed.service \
    microshift.service \
    microshift-storage-setup.service
